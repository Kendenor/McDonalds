rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isSignedIn() && (
        request.auth.token.email == 'mcdonald@gmail.com' ||
        request.auth.token.email == 'McDonald@gmail.com'
      );
    }
    
    function isSuperAdmin() {
      return isSignedIn() && request.auth.token.email == 'mcdonald@gmail.com';
    }
    
    // --- User Profiles ---
    match /users/{userId} {
      // Users can create their own profile
      allow create: if isOwner(userId);
      
      // Users can read their own data, admins can read any user's data
      // IMPORTANT: Allow reading other users for referral lookups
      allow read: if isSignedIn();
      
      // Users can update their own data, admins can update any user's data
      // IMPORTANT: Allow updating other users for referral bonus processing
      allow update: if isSignedIn();
      
      // Allow listing users for referral code lookups (needed for registration)
      allow list: if isSignedIn();
      
      // Only super admin can delete users
      allow delete: if isSuperAdmin();
      
      // User's investments
      match /investments/{investmentId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
      
      // User's referrals
      match /referrals/{referralId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
      
      // User's notifications
      match /notifications/{notificationId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
      
      // User's funding records
      match /funding_records/{recordId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
      
      // User's team (referrals)
      match /team/{teamMemberId} {
        allow read: if isOwner(userId);
        allow write: if isAdmin();
      }
      
      // User's purchased products
      match /purchasedProducts/{productId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
    }
    
    // --- Purchased Products (Top-level collection) ---
    match /purchased_products/{productId} {
      // Users can create their own purchased products
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      // Users can read their own products, admins can read all
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      
      // Users can update their own products, admins can update any
      allow update: if isSignedIn() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      
      // Only admins can delete products
      allow delete: if isAdmin();
    }
    
    // --- Claims ---
    match /claims/{claimId} {
      // Users can create their own claims
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      // Users can read their own claims, admins can read all
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      
      // Users can update their own claims, admins can update any
      allow update: if isSignedIn() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      
      // Only admins can delete claims
      allow delete: if isAdmin();
    }
    
    // --- Notifications (Top-level collection) ---
    match /notifications/{notificationId} {
      // Users can create their own notifications
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      // Users can read their own notifications, admins can read all
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      
      // Users can update their own notifications, admins can update any
      allow update: if isSignedIn() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      
      // Users can delete their own notifications, admins can delete any
      allow delete: if isSignedIn() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      
      // Allow listing notifications for referral processing
      allow list: if isSignedIn();
    }
    
    // --- Transactions ---
    match /transactions/{transactionId} {
      // Users can create their own transactions
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      // Users can read their own transactions, admins can read all
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      
      // Users can update their own transactions, admins can update any
      allow update: if isSignedIn() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      
      // Only admins can delete transactions
      allow delete: if isAdmin();
      
      // Allow listing transactions for referral processing
      allow list: if isSignedIn();
    }
    
    // --- Deposits ---
    match /deposits/{depositId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read, update: if isSignedIn() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow delete: if isAdmin();
    }
    
    // --- Withdrawals ---
    match /withdrawals/{withdrawalId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read, update: if isSignedIn() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow delete: if isAdmin();
    }
    
    // --- Products ---
    match /products/{productId} {
      // Anyone can read products
      allow read: if true;
      // Only admins can write products
      allow write: if isAdmin();
    }
    
    // --- App Settings ---
    match /settings/{settingId} {
      // Anyone can read settings
      allow read: if true;
      // Only admins can write settings
      allow write: if isAdmin();
    }
    
    // --- Global Settings ---
    match /settings/global {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // --- App Settings (alternative path) ---
    match /app_settings {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // --- Announcements ---
    match /announcements/{announcementId} {
      // Anyone can read announcements
      allow read: if true;
      // Only admins can write announcements
      allow write: if isAdmin();
    }
    
    // --- Bank Accounts ---
    match /bank_accounts/{accountId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // --- System Documents ---
    match /system/{docId} {
      allow read, write: if isAdmin();
    }
    
    // --- Test Documents (for debugging) ---
    match /test/{docId} {
      allow read, write: if isAdmin();
    }
    
    // --- Admin Notifications ---
    match /admin_notifications/{notificationId} {
      allow read: if isAdmin();
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }
    
    // --- Admin Users ---
    match /admins/{adminId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }
    
    // --- Agent Features ---
    match /topup_requests/{requestId} {
      allow create: if isSignedIn() && request.resource.data.agentId == request.auth.uid;
      allow read, update, delete: if isAdmin();
    }
    
    match /agent_transfers/{transferId} {
      allow read: if isSignedIn() && (
        request.auth.uid in resource.data.userIds || isAdmin()
      );
      allow list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    // --- Promotions ---
    match /promotions/{promotionId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // --- Product Sold Counts ---
    match /product_sold_counts/{productId} {
      allow read: if true;
      allow create, update: if isSignedIn();
      allow delete: if isAdmin();
    }
    
    // --- Data Collection (for admin dashboard) ---
    match /data/{docId} {
      allow read, write: if isAdmin();
    }
    
    // --- Referrals (Top-level collection for referral system) ---
    match /referrals/{referralId} {
      allow read, write: if isSignedIn();
    }
    
    // --- Investment Plans ---
    match /investment_plans/{planId} {
      allow read, write: if isSignedIn();
    }
    
    // --- Any other documents ---
    match /{document=**} {
      // Default: allow read for signed-in users, write for admins
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
  }
} 